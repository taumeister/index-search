<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>System</title>
    <script>
        (function applySavedZoomEarly() {
            const KEY = "appZoom";
            const DEFAULT_ZOOM = 1;
            const clamp = (v) => Math.min(1.6, Math.max(0.6, v));
            try {
                const raw = localStorage.getItem(KEY);
                const parsed = parseFloat(raw);
                const zoom = Number.isFinite(parsed) ? clamp(parsed) : DEFAULT_ZOOM;
                document.documentElement.style.setProperty("--app-zoom", zoom);
            } catch (err) {
                document.documentElement.style.setProperty("--app-zoom", DEFAULT_ZOOM);
            }
        })();
    </script>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        body { background: #f0f3f8; }
        .system-layout { display: grid; grid-template-columns: 280px 1fr; gap: 12px; padding: 12px; }
        .panel { background: #fff; border: 1px solid #d7dde7; border-radius: 8px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .panel h2 { margin: 4px 0 8px 0; font-size: 16px; }
        .tree ul { list-style: none; padding-left: 14px; margin: 0; }
        .tree li { cursor: pointer; padding: 2px 0; }
        .roots-list { display: flex; flex-direction: column; gap: 6px; }
        .root-item { border: 1px solid #d7dde7; border-radius: 6px; padding: 6px 8px; display: flex; justify-content: space-between; align-items: center; }
        .chips { display: flex; gap: 6px; flex-wrap: wrap; }
        .chip { background: #e5e7eb; border-radius: 12px; padding: 2px 8px; font-size: 12px; }
        table.status { width: 100%; border-collapse: collapse; }
        table.status th, table.status td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        button.destructive { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }
        .error-list { max-height: 260px; overflow: auto; }
        .error-item { border-bottom: 1px solid #e5e7eb; padding: 4px 0; }
        .button-link { padding: 8px 12px; background: #e5e7eb; border-radius: 6px; text-decoration: none; color: #111827; border: 1px solid #cbd5e1; }
        .toggle { cursor: pointer; margin-right: 4px; color: #4b5563; }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <h1>System &amp; Index</h1>
            <div class="header-actions">
                <a href="/" class="button-link">Zur Suche</a>
            </div>
        </div>
    </header>
    <div class="system-layout">
        <section class="panel">
            <h2>Basis-Ordner</h2>
            <div id="base-root"></div>
            <h3>Explorer</h3>
            <div class="tree" id="tree"></div>
        </section>
        <section class="panel">
            <div class="actions">
                <button id="start-run">Index starten</button>
                <button id="stop-run">Index stoppen</button>
                <button id="preflight">Preflight (zählen)</button>
                <button id="reset-run" class="destructive">Index leeren (ohne Start)</button>
                <button id="reset-run-start" class="destructive">Index leeren &amp; neu starten</button>
            </div>
            <div class="chips" id="ext-counts"></div>
            <div id="preflight-result" style="font-size:13px;color:#374151;"></div>
            <h2>Roots</h2>
            <div class="roots-list" id="roots"></div>
            <div style="margin-top:8px;">
                <input type="text" id="new-path" placeholder="Pfad aus Explorer wählen oder tippen" style="width:60%;">
                <input type="text" id="new-label" placeholder="Label" style="width:20%;">
                <button id="add-root">Hinzufügen</button>
            </div>
            <h2>Status</h2>
            <table class="status">
                <tbody id="status-body"></tbody>
            </table>
            <h2>Letzte Läufe</h2>
            <table class="status">
                <thead><tr><th>Start</th><th>Status</th><th>Scanned</th><th>Added</th><th>Errors</th></tr></thead>
                <tbody id="runs-body"></tbody>
            </table>
            <h2>Fehler</h2>
            <div class="error-list" id="errors"></div>
            <div class="actions">
                <button id="prev-errors">Zurück</button>
                <button id="next-errors">Weiter</button>
                <span id="errors-info"></span>
            </div>
        </section>
    </div>
    <script>
        const SECRET_STORAGE_KEY = "appSecret";
        function readCookie(name) {
            const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
            return match ? decodeURIComponent(match[2]) : null;
        }
        function persistSecret(secret) {
            if (!secret) return;
            sessionStorage.setItem(SECRET_STORAGE_KEY, secret);
            document.cookie = `app_secret=${encodeURIComponent(secret)}; path=/; SameSite=Lax`;
        }
        function ensureAppSecret() {
            let secret = sessionStorage.getItem(SECRET_STORAGE_KEY) || readCookie("app_secret");
            if (secret) {
                persistSecret(secret);
                return secret;
            }
            secret = prompt("Bitte App-Secret eingeben");
            if (secret) {
                secret = secret.trim();
                persistSecret(secret);
                return secret;
            }
            alert("Ohne App-Secret sind keine Anfragen möglich.");
            return null;
        }
        ensureAppSecret();

        const state = { baseRoot: "", tree: [], roots: [] };
        let errorOffset = 0;
        const errorLimit = 50;

        async function fetchJSON(url, opts={}) {
            if (!ensureAppSecret()) {
                throw new Error("Kein App-Secret gesetzt");
            }
            const res = await fetch(url, opts);
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function loadChildren(path, ul) {
            const data = await fetchJSON(`/api/admin/tree?parent=${encodeURIComponent(path || "")}`);
            return data.children || [];
        }

        function createNode(n, depth=0) {
            const li = document.createElement("li");
            const toggle = document.createElement("span");
            toggle.className = "toggle";
            toggle.textContent = n.has_children ? "▶" : "";
            toggle.addEventListener("click", async (e) => {
                e.stopPropagation();
                if (!n.has_children) return;
                if (li.dataset.expanded === "true") {
                    li.dataset.expanded = "false";
                    toggle.textContent = "▶";
                    const childUl = li.querySelector("ul");
                    if (childUl) childUl.remove();
                } else {
                    li.dataset.expanded = "true";
                    toggle.textContent = "▼";
                    const childUl = document.createElement("ul");
                    const children = await loadChildren(n.path, childUl);
                    children.forEach((c) => childUl.appendChild(createNode(c, depth + 1)));
                    li.appendChild(childUl);
                }
            });
            const label = document.createElement("span");
            label.textContent = n.name;
            label.title = n.path;
            label.addEventListener("click", (e) => {
                e.stopPropagation();
                document.getElementById("new-path").value = n.path;
            });
            li.appendChild(toggle);
            li.appendChild(label);
            return li;
        }

        async function loadTree() {
            const data = await fetchJSON("/api/admin/tree");
            state.baseRoot = data.base;
            document.getElementById("base-root").textContent = data.base;
            const container = document.getElementById("tree");
            container.innerHTML = "";
            const rootBtn = document.createElement("button");
            rootBtn.textContent = data.base;
            rootBtn.addEventListener("click", () => {
                document.getElementById("new-path").value = data.base;
            });
            container.appendChild(rootBtn);
            const ul = document.createElement("ul");
            (data.children || []).forEach((c) => ul.appendChild(createNode(c, 0)));
            container.appendChild(ul);
        }

        async function loadRoots() {
            const data = await fetchJSON("/api/admin/roots");
            state.roots = data.roots;
            const list = document.getElementById("roots");
            list.innerHTML = "";
            data.roots.forEach((r) => {
                const div = document.createElement("div");
                div.className = "root-item";
                div.innerHTML = `<span>${r.label} — ${r.path}</span>
                <span>
                    <button data-act="${r.id}" data-active="${!r.active}">${r.active ? "Deaktivieren" : "Aktivieren"}</button>
                    <button data-del="${r.id}">Löschen</button>
                </span>`;
                list.appendChild(div);
            });
            list.querySelectorAll("button[data-act]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.act;
                    const active = btn.dataset.active === "true";
                    await fetchJSON(`/api/admin/roots/${id}/activate?active=${active}`, { method: "POST" });
                    loadRoots();
                });
            });
            list.querySelectorAll("button[data-del]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.del;
                    await fetchJSON(`/api/admin/roots/${id}`, { method: "DELETE" });
                    loadRoots();
                });
            });
        }

        function fmtDate(s) {
            if (!s) return "";
            const d = new Date(s);
            return d.toLocaleString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        }

        async function loadStatus() {
            const data = await fetchJSON("/api/admin/status");
            const b = document.getElementById("status-body");
            b.innerHTML = `
                <tr><td>Dokumente gesamt</td><td>${data.total_docs}</td></tr>
            `;
            const ext = document.getElementById("ext-counts");
            ext.innerHTML = "";
            (data.ext_counts || []).forEach((row) => {
                const chip = document.createElement("span");
                chip.className = "chip";
                chip.textContent = `${row.extension || "?"}: ${row.c}`;
                ext.appendChild(chip);
            });
            const runs = document.getElementById("runs-body");
            runs.innerHTML = "";
            (data.recent_runs || []).forEach((r) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${fmtDate(r.started_at)} - ${fmtDate(r.finished_at)}</td><td>${r.status || ""}</td><td>${r.scanned_files || ""}</td><td>${r.added || ""}</td><td>${r.errors || ""}</td>`;
                runs.appendChild(tr);
            });
        }

        async function loadErrors() {
            const data = await fetchJSON(`/api/admin/errors?limit=${errorLimit}&offset=${errorOffset}`);
            const box = document.getElementById("errors");
            box.innerHTML = "";
            (data.errors || []).forEach((e) => {
                const div = document.createElement("div");
                div.className = "error-item";
                div.textContent = `${e.created_at}: ${e.path} — ${e.error_type} (${e.message})`;
                box.appendChild(div);
            });
            const info = document.getElementById("errors-info");
            info.textContent = `${Math.min(data.total, errorOffset + 1)} - ${Math.min(data.total, errorOffset + errorLimit)} / ${data.total || 0}`;
            document.getElementById("prev-errors").disabled = errorOffset <= 0;
            document.getElementById("next-errors").disabled = errorOffset + errorLimit >= (data.total || 0);
        }

        async function triggerRun(fullReset=false) {
            const res = await fetch(`/api/admin/index/run?full_reset=${fullReset}`, { method: "POST" });
            if (res.status === 409) {
                alert("Indexlauf läuft bereits");
            }
        }

        document.getElementById("start-run").addEventListener("click", () => triggerRun(false));
        document.getElementById("reset-run").addEventListener("click", async () => {
            if (confirm("Index leeren? Dies startet keinen neuen Lauf.")) {
                await fetchJSON(`/api/admin/index/reset`, { method: "POST" });
                loadStatus();
                loadErrors();
            }
        });
        document.getElementById("preflight").addEventListener("click", async () => {
            const data = await fetchJSON("/api/admin/preflight");
            const box = document.getElementById("preflight-result");
            box.textContent = `Preflight: PDF ${data.counts[".pdf"]} | RTF ${data.counts[".rtf"]} | MSG ${data.counts[".msg"]} | TXT ${data.counts[".txt"]}`;
        });
        document.getElementById("reset-run-start").addEventListener("click", async () => {
            if (confirm("Index leeren und direkt neu starten?")) {
                await fetchJSON(`/api/admin/index/reset_run`, { method: "POST" });
            }
        });
        document.getElementById("stop-run").addEventListener("click", async () => {
            await fetchJSON(`/api/admin/index/stop`, { method: "POST" });
        });
        document.getElementById("add-root").addEventListener("click", async () => {
            const path = document.getElementById("new-path").value.trim();
            const label = document.getElementById("new-label").value.trim();
            if (!path) return;
            await fetchJSON(`/api/admin/roots?path=${encodeURIComponent(path)}&label=${encodeURIComponent(label)}`, { method: "POST" });
            loadRoots();
        });

        async function refreshAll() {
            await Promise.all([loadTree(), loadRoots(), loadStatus(), loadErrors()]);
        }

        refreshAll();
        setInterval(loadStatus, 5000);

        document.getElementById("prev-errors").addEventListener("click", () => {
            errorOffset = Math.max(0, errorOffset - errorLimit);
            loadErrors();
        });
        document.getElementById("next-errors").addEventListener("click", () => {
            errorOffset = errorOffset + errorLimit;
            loadErrors();
        });
    </script>
</body>
</html>

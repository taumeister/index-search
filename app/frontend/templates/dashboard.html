<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>System</title>
    <script>
        (function enforceDefaultZoom() {
            const KEY = "appZoom";
            const DEFAULT_ZOOM = 1;
            try {
                localStorage.removeItem(KEY);
            } catch (_) {
                /* ignore */
            }
            document.documentElement.style.setProperty("--app-zoom", DEFAULT_ZOOM);
        })();
    </script>
    <script>
        (function applyStoredTheme() {
            const KEY = "theme";
            const DEFAULT_THEME = "lumen-atelier";
            let theme = DEFAULT_THEME;
            try {
                const stored = localStorage.getItem(KEY);
                if (stored && typeof stored === "string") {
                    theme = stored;
                }
            } catch (_) {
                /* ignore */
            }
            document.documentElement.setAttribute("data-theme", theme);
        })();
    </script>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body class="dashboard-body">
    {% set header_title = "System & Index" %}
    {% set header_subtitle = "Live-Übersicht für Laufstatus, Log und Fehler" %}
    {% set header_eyebrow = None %}
    {% set version_badge = None %}
    {% set header_actions = [
        {"type":"icon","href":"/","label":"Suche","icon":"search"},
        {"type":"icon","href":"/metrics","label":"Metrics","icon":"metrics"}
    ] %}
    <header class="app-header">
        {% include "partials/header_top.html" with context %}
    </header>
    <div class="system-layout">
        <div class="row top">
            <section class="panel live-panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Index-Live</div>
                        <h2>Indexstatus</h2>
                        <div class="subtext">Aktuelle Kennzahlen und Fortschritt</div>
                    </div>
                    <div class="status-pill" id="status-pill" data-state="idle">Wartet</div>
                </div>
                <div class="action-row chips">
                    <button id="start-run" class="btn btn-primary">Index starten</button>
                    <button id="stop-run" class="btn btn-secondary">Index stoppen</button>
                    <button id="preflight" class="btn btn-secondary">Preflight (zählen)</button>
                    <button id="reset-run" class="btn btn-danger">Index leeren</button>
                    <button id="reset-run-start" class="btn btn-danger">Leeren &amp; neu starten</button>
                    <label class="chip chip-muted">
                        <input type="checkbox" id="toggle-report"> Mail senden
                    </label>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card primary">
                        <div class="metric-label">Status</div>
                        <div class="metric-value" id="metric-status">–</div>
                        <div class="metric-sub" id="last-run-label">Letzter Lauf –</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Dokumente im Index</div>
                        <div class="metric-value" id="metric-total-docs">–</div>
                        <div class="metric-sub">DB-Stand</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Zu scannen</div>
                        <div class="metric-value" id="metric-total-scan">–</div>
                        <div class="metric-sub">Dateien im Lauf</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Gescannt</div>
                        <div class="metric-value" id="metric-scanned">–</div>
                        <div class="metric-sub">inkl. übersprungen</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">OK</div>
                        <div class="metric-value" id="metric-ok">–</div>
                        <div class="metric-sub">ohne Fehler</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Fehler</div>
                        <div class="metric-value" id="metric-errors">–</div>
                        <div class="metric-sub">laufender Lauf</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Hinzugefügt</div>
                        <div class="metric-value" id="metric-added">–</div>
                        <div class="metric-sub">neue Dokumente</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Aktualisiert</div>
                        <div class="metric-value" id="metric-updated">–</div>
                        <div class="metric-sub">geändert</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Entfernt</div>
                        <div class="metric-value" id="metric-removed">–</div>
                        <div class="metric-sub">verwaist</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Übersprungen</div>
                        <div class="metric-value" id="metric-skipped">–</div>
                        <div class="metric-sub">unverändert/zu groß</div>
                    </div>
                </div>
                <div class="progress-row">
                    <div class="progress-shell"><div class="progress-bar" id="progress-bar"></div></div>
                    <div class="subtext" id="progress-text">–</div>
                </div>
                <div class="live-meta">
                    <div class="meta-item"><strong>Run:</strong> <span id="run-id">–</span></div>
                    <div class="meta-item"><strong>Start:</strong> <span id="started-at">–</span></div>
                    <div class="meta-item"><strong>Laufzeit:</strong> <span id="runtime-label">–</span></div>
                    <div class="meta-item"><strong>Letztes Signal:</strong> <span id="heartbeat-label">–</span></div>
                </div>
                <div class="live-meta">
                    <div class="meta-item"><strong>Aktuelle Datei:</strong> <span id="current-file">–</span></div>
                    <div class="meta-item"><strong>Preflight:</strong> <span id="preflight-result">Noch nicht geprüft.</span></div>
                </div>
                <div class="chip-row" id="ext-counts"></div>
                <div style="margin-top: 10px;">
                    <div class="eyebrow">Letzte Läufe</div>
                    <table class="status-table">
                        <thead><tr><th>Start</th><th>Status</th><th>Gescannt</th><th>Added</th><th>Errors</th></tr></thead>
                        <tbody id="runs-body"></tbody>
                    </table>
                </div>
            </section>
            <section class="panel roots-panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Quellen</div>
                        <h2>Roots &amp; Explorer</h2>
                    </div>
                </div>
                <div class="meta-grid">
                    <div>
                        <strong>Basis-Ordner</strong><br>
                        <span id="base-root"></span>
                    </div>
                </div>
                <div class="tree" id="tree"></div>
                <div class="roots-list" id="roots"></div>
                <div class="add-root-row">
                    <input type="text" id="new-path" placeholder="Pfad aus Explorer wählen oder tippen" style="flex:2;">
                    <input type="text" id="new-label" placeholder="Label" style="flex:1;">
                    <button id="add-root" class="btn btn-primary">Hinzufügen</button>
                </div>
            </section>
        </div>
        <div class="row middle">
            <section class="panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Auto-Index</div>
                        <h2>Zeitplan</h2>
                        <div class="subtext">Geplante Re-Indexierung aller Quellen</div>
                    </div>
                    <div class="status-pill" id="auto-status-pill" data-state="idle">Wartet</div>
                </div>
                <div class="auto-grid">
                    <div class="auto-card">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="auto-enabled"> Auto-Index aktivieren
                        </label>
                        <div class="muted">Einstellungen speichern oder ändern, um Zeitplan zu aktivieren.</div>
                        <div class="btn-group" id="auto-mode-buttons">
                            <button class="btn-ghost" data-mode="daily">Täglich</button>
                            <button class="btn-ghost" data-mode="weekly">Wöchentlich</button>
                            <button class="btn-ghost" data-mode="interval">Intervall</button>
                        </div>
                        <div class="inline-field" id="auto-time-wrap">
                            <label for="auto-time">Uhrzeit</label>
                            <input type="time" id="auto-time" value="02:00" style="max-width: 200px;">
                        </div>
                        <div class="btn-group">
                            <button class="btn-ghost" id="auto-save">Plan speichern</button>
                            <button class="btn-ghost" id="auto-run-now">Jetzt ausführen</button>
                        </div>
                    </div>
                    <div class="auto-card">
                        <div class="inline-field" id="auto-weekday-wrap">
                            <label>Wochentag (wöchentlich)</label>
                            <div class="btn-group" id="auto-weekdays">
                                <button class="btn-ghost" data-day="0">Mo</button>
                                <button class="btn-ghost" data-day="1">Di</button>
                                <button class="btn-ghost" data-day="2">Mi</button>
                                <button class="btn-ghost" data-day="3">Do</button>
                                <button class="btn-ghost" data-day="4">Fr</button>
                                <button class="btn-ghost" data-day="5">Sa</button>
                                <button class="btn-ghost" data-day="6">So</button>
                            </div>
                        </div>
                        <div class="inline-field" id="auto-interval-wrap">
                            <label>Intervall (Stunden)</label>
                            <div class="btn-group" id="auto-interval-buttons">
                                <button class="btn-ghost" data-interval="1">1h</button>
                                <button class="btn-ghost" data-interval="2">2h</button>
                                <button class="btn-ghost" data-interval="6">6h</button>
                                <button class="btn-ghost" data-interval="12">12h</button>
                            </div>
                        </div>
                    </div>
                    <div class="auto-card">
                        <div class="status-line">
                            <div><strong>Nächster Lauf:</strong> <span id="auto-next">–</span></div>
                            <div><strong>Letzter Lauf:</strong> <span id="auto-last">–</span></div>
                            <div><strong>Dauer:</strong> <span id="auto-duration">–</span></div>
                        </div>
                        <div class="status-line">
                            <div><strong>Status:</strong> <span id="auto-status-label">Idle</span></div>
                            <div><strong>Fehler:</strong> <span id="auto-error">–</span></div>
                            <div><strong>Plan:</strong> <span id="auto-plan">–</span></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div class="row quarantine-row">
            <section class="panel quarantine-panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Quarantäne</div>
                        <h2>Gesperrte Dateien</h2>
                        <div class="subtext">Restore oder endgültig löschen</div>
                    </div>
                    <div class="status-pill" id="quarantine-availability" data-state="idle">Status</div>
                </div>
                <div class="chip-row" id="quarantine-meta">
                    <span class="pill" id="quarantine-retention">Retention: –</span>
                    <span class="pill" id="quarantine-schedule">Cleanup: –</span>
                </div>
                <div class="quarantine-controls">
                    <select id="quarantine-source-filter" aria-label="Quelle filtern">
                        <option value="">Alle Quellen</option>
                    </select>
                    <select id="quarantine-age-filter" aria-label="Alter filtern">
                        <option value="">Alter: alle</option>
                        <option value="7">≤ 7 Tage</option>
                        <option value="30">≤ 30 Tage</option>
                        <option value="90">≤ 90 Tage</option>
                    </select>
                    <input type="search" id="quarantine-search" placeholder="Suche nach Name/Pfad" aria-label="Quarantäne-Suche">
                    <button id="quarantine-refresh" class="btn btn-secondary">Aktualisieren</button>
                </div>
                <div class="quarantine-table-wrap">
                    <table class="quarantine-table">
                        <thead>
                            <tr>
                                <th>Datei</th>
                                <th>Quelle</th>
                                <th>Originalpfad</th>
                                <th>Quarantäne</th>
                                <th>Größe</th>
                                <th>Seit</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="quarantine-rows">
                            <tr><td colspan="7" class="muted">Lade…</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
        <div class="row bottom">
            <section class="panel log-panel">
                <div class="panel-head">
                    <div>
                        <div class="eyebrow">Indexer</div>
                        <h2>Live-Log</h2>
                        <div class="subtext">Letzte Zeilen + Streaming</div>
                    </div>
                    <div class="chip-row action-row">
                        <button id="live-log" class="btn btn-ghost">Live</button>
                        <button id="older-log" class="btn btn-ghost">Ältere</button>
                        <button id="refresh-log" class="btn btn-ghost">Neu laden</button>
                        <button id="toggle-autoscroll" class="btn btn-ghost">Autoscroll an</button>
                    </div>
                </div>
                <div class="log-box" id="indexer-log"></div>
                <div class="subtext" id="log-info">–</div>
            </section>
        </div>
    </div>
    </div>
    <script>
        const state = { errorOffset: 0, errorLimit: 50, logOffset: 0, logPointer: 0, logTail: 400, logTotal: 0, autoScrollLog: true, autoMode: "daily", autoRunning: false };
        const POLL_STATUS_MS = 2000;
        const POLL_LOG_MS = 2000;
        const POLL_ERRORS_MS = 15000;
        const quarantineState = { entries: [], sourceFilter: "", ageFilter: "", search: "", loading: false };
        let quarantineSearchTimer = null;

        async function fetchJSON(url, opts = {}) {
            const res = await fetch(url, opts);
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || res.statusText);
            }
            return res.json();
        }

        function escapeHtml(str) {
            return String(str || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function formatSize(bytes) {
            const n = Number(bytes);
            if (!Number.isFinite(n) || n < 0) return "–";
            if (n < 1024) return `${n} B`;
            if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
            if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(1)} MB`;
            return `${(n / (1024 * 1024 * 1024)).toFixed(1)} GB`;
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function fmtNumber(value) {
            const n = Number(value || 0);
            return Number.isFinite(n) ? n.toLocaleString("de-DE") : "0";
        }

        function fmtDateTime(value) {
            if (!value) return "–";
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return "–";
            return d.toLocaleString("de-DE", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        }

        function fmtDuration(sec) {
            const total = Math.max(0, Math.floor(sec || 0));
            const h = Math.floor(total / 3600).toString().padStart(2, "0");
            const m = Math.floor((total % 3600) / 60).toString().padStart(2, "0");
            const s = Math.floor(total % 60).toString().padStart(2, "0");
            return `${h}:${m}:${s}`;
        }

        function updateQuarantineMeta(statusData) {
            const pill = document.getElementById("quarantine-availability");
            const readyList = Array.isArray(statusData && statusData.quarantine_ready_sources) ? statusData.quarantine_ready_sources : [];
            const enabled = Boolean(statusData && statusData.file_ops_enabled && readyList.length);
            if (pill) {
                pill.textContent = enabled ? "Bereit" : "Nicht bereit";
                pill.dataset.state = enabled ? "running" : "idle";
            }
            const retention = document.getElementById("quarantine-retention");
            if (retention) {
                const days = statusData && statusData.quarantine_retention_days != null ? statusData.quarantine_retention_days : "–";
                retention.textContent = `Retention: ${days} Tage`;
            }
            const schedule = document.getElementById("quarantine-schedule");
            if (schedule) {
                const sched = (statusData && statusData.quarantine_cleanup_schedule) || "–";
                const dry = statusData && statusData.quarantine_cleanup_dry_run ? " (Dry-run)" : "";
                schedule.textContent = `Cleanup: ${sched}${dry}`;
            }
            const sourceSelect = document.getElementById("quarantine-source-filter");
            if (sourceSelect) {
                const prev = sourceSelect.value;
                sourceSelect.innerHTML = '<option value="">Alle Quellen</option>';
                readyList.forEach((item) => {
                    const val = item.label || item;
                    if (!val) return;
                    const opt = document.createElement("option");
                    opt.value = val;
                    opt.textContent = val;
                    sourceSelect.appendChild(opt);
                });
                if (Array.from(sourceSelect.options).some((opt) => opt.value === prev)) {
                    sourceSelect.value = prev;
                }
            }
        }

        function renderQuarantine(entries) {
            const body = document.getElementById("quarantine-rows");
            if (!body) return;
            if (!Array.isArray(entries) || entries.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="muted">Keine Quarantäne-Einträge</td></tr>';
                return;
            }
            body.innerHTML = "";
            entries.forEach((e) => {
                const tr = document.createElement("tr");
                const movedAt = e.moved_at ? fmtDateTime(e.moved_at) : "–";
                const sizeLabel = formatSize(e.size_bytes);
                const originalPath = e.original_path || "";
                const quarantinePath = e.quarantine_path || "";
                tr.innerHTML = `
                    <td>${escapeHtml(e.original_filename || "")}</td>
                    <td>${escapeHtml(e.source || "")}</td>
                    <td class="path" title="${escapeHtml(originalPath)}">${escapeHtml(originalPath)}</td>
                    <td class="quarantine-col" title="${escapeHtml(quarantinePath)}">${escapeHtml(quarantinePath)}</td>
                    <td class="small">${sizeLabel}</td>
                    <td class="small">${movedAt}</td>
                    <td class="actions">
                        <div class="quarantine-actions" data-id="${e.id}">
                            <button class="btn btn-secondary" data-action="restore">Restore</button>
                            <button class="btn btn-danger" data-action="hard-delete">Löschen</button>
                        </div>
                    </td>`;
                body.appendChild(tr);
            });
            body.querySelectorAll(".quarantine-actions").forEach((wrap) => {
                const id = wrap.dataset.id;
                wrap.addEventListener("click", (ev) => {
                    const action = ev.target.dataset.action;
                    if (action === "restore") {
                        restoreEntry(id);
                    } else if (action === "hard-delete") {
                        const row = ev.target.closest("tr");
                        const name = row ? row.children[0].textContent.trim() : "";
                        hardDeleteEntry(id, name);
                    }
                });
            });
        }

        async function loadQuarantine() {
            const body = document.getElementById("quarantine-rows");
            if (!body) return;
            quarantineState.loading = true;
            body.innerHTML = '<tr><td colspan="7" class="muted">Lade…</td></tr>';
            const params = [];
            if (quarantineState.sourceFilter) params.push(`source=${encodeURIComponent(quarantineState.sourceFilter)}`);
            if (quarantineState.search) params.push(`q=${encodeURIComponent(quarantineState.search)}`);
            if (quarantineState.ageFilter) params.push(`max_age_days=${quarantineState.ageFilter}`);
            const url = `/api/quarantine/list${params.length ? "?" + params.join("&") : ""}`;
            try {
                const data = await fetchJSON(url);
                quarantineState.entries = Array.isArray(data.entries) ? data.entries : [];
                renderQuarantine(quarantineState.entries);
            } catch (err) {
                body.innerHTML = `<tr><td colspan="7" class="muted">Quarantäne nicht verfügbar (${escapeHtml(err.message || err)})</td></tr>`;
            } finally {
                quarantineState.loading = false;
            }
        }

        async function restoreEntry(id) {
            if (!id) return;
            if (!confirm("Datei wiederherstellen?")) return;
            try {
                await fetchJSON(`/api/quarantine/${id}/restore`, { method: "POST" });
                await loadQuarantine();
                await refreshStatus();
            } catch (err) {
                alert(`Restore fehlgeschlagen: ${err}`);
            }
        }

        async function hardDeleteEntry(id, name) {
            if (!id) return;
            const label = name ? ` ${name}` : "";
            if (!confirm(`Endgültig löschen${label}?`)) return;
            if (!confirm("Sicher? Datei wird dauerhaft entfernt.")) return;
            try {
                await fetchJSON(`/api/quarantine/${id}/hard-delete`, { method: "POST" });
                await loadQuarantine();
                await refreshStatus();
            } catch (err) {
                alert(`Löschen fehlgeschlagen: ${err}`);
            }
        }

        function wireQuarantineControls() {
            const sourceSelect = document.getElementById("quarantine-source-filter");
            const ageSelect = document.getElementById("quarantine-age-filter");
            const searchInput = document.getElementById("quarantine-search");
            const refreshBtn = document.getElementById("quarantine-refresh");
            sourceSelect?.addEventListener("change", () => {
                quarantineState.sourceFilter = sourceSelect.value;
                loadQuarantine();
            });
            ageSelect?.addEventListener("change", () => {
                quarantineState.ageFilter = ageSelect.value;
                loadQuarantine();
            });
            if (searchInput) {
                searchInput.addEventListener("input", () => {
                    window.clearTimeout(quarantineSearchTimer);
                    quarantineSearchTimer = window.setTimeout(() => {
                        quarantineState.search = searchInput.value.trim();
                        loadQuarantine();
                    }, 250);
                });
            }
            refreshBtn?.addEventListener("click", () => loadQuarantine());
        }

        function describePlan(cfg) {
            if (!cfg.enabled) return "aus";
            const t = cfg.time || "02:00";
            if (cfg.mode === "daily") return `täglich ${t}`;
            if (cfg.mode === "weekly") {
                const days = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
                const d = days[(cfg.weekday ?? 0) % 7] || "Mo";
                return `wöchentlich ${d} ${t}`;
            }
            if (cfg.mode === "interval") return `alle ${cfg.interval_hours || 6}h`;
            return "aus";
        }

        function renderAutoModeButtons(active) {
            const btns = document.querySelectorAll("#auto-mode-buttons button");
            btns.forEach((b) => {
                const isActive = b.dataset.mode === active;
                b.classList.toggle("active", isActive);
                b.setAttribute("aria-pressed", isActive ? "true" : "false");
            });
        }

        function renderWeekdayButtons(activeDay) {
            document.querySelectorAll("#auto-weekdays button").forEach((btn) => {
                const isActive = parseInt(btn.dataset.day, 10) === activeDay;
                btn.classList.toggle("active", isActive);
                btn.setAttribute("aria-pressed", isActive ? "true" : "false");
            });
        }

        function renderIntervalButtons(active) {
            document.querySelectorAll("#auto-interval-buttons button").forEach((btn) => {
                const isActive = parseInt(btn.dataset.interval, 10) === active;
                btn.classList.toggle("active", isActive);
                btn.setAttribute("aria-pressed", isActive ? "true" : "false");
            });
        }

        function toggleAutoInputs(mode) {
            const timeWrap = document.getElementById("auto-time-wrap");
            const weekdayWrap = document.getElementById("auto-weekday-wrap");
            const intervalWrap = document.getElementById("auto-interval-wrap");
            if (timeWrap) timeWrap.style.display = mode === "interval" ? "none" : "flex";
            if (weekdayWrap) weekdayWrap.style.display = mode === "weekly" ? "flex" : "none";
            if (intervalWrap) intervalWrap.style.display = mode === "interval" ? "flex" : "none";
        }

        function updateAutoStatusPill(text, code) {
            const pill = document.getElementById("auto-status-pill");
            if (!pill) return;
            pill.textContent = text;
            pill.dataset.state = code || "idle";
        }

        function currentAutoConfigFromUI() {
            const enabled = document.getElementById("auto-enabled").checked;
            const time = document.getElementById("auto-time").value || "02:00";
            const weekdayBtn = document.querySelector("#auto-weekdays button.active");
            const weekday = weekdayBtn ? parseInt(weekdayBtn.dataset.day, 10) : 0;
            const intervalBtn = document.querySelector("#auto-interval-buttons button.active");
            const interval = intervalBtn ? parseInt(intervalBtn.dataset.interval, 10) : 6;
            return {
                enabled,
                mode: state.autoMode || "daily",
                time,
                weekday,
                interval_hours: interval,
            };
        }

        async function saveAutoConfig() {
            try {
                const cfg = currentAutoConfigFromUI();
                const res = await fetchJSON("/api/auto-index/config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cfg),
                });
                renderAutoConfig(res);
            } catch (err) {
                console.error("Auto-Index speichern fehlgeschlagen", err);
            }
        }

        function renderAutoConfig(res) {
            if (!res || !res.config) return;
            const cfg = res.config;
            const st = res.status || {};
            state.autoMode = cfg.mode || "daily";
            const enabled = Boolean(cfg.enabled);
            document.getElementById("auto-enabled").checked = enabled;
            document.getElementById("auto-time").value = cfg.time || "02:00";
            renderAutoModeButtons(state.autoMode);
            toggleAutoInputs(state.autoMode);
            renderWeekdayButtons(cfg.weekday ?? 0);
            renderIntervalButtons(cfg.interval_hours ?? 6);
            const running = Boolean(st.running);
            state.autoRunning = running;
            document.getElementById("auto-run-now").disabled = running;
            updateAutoStatusPill(running ? "Läuft" : "Wartet", running ? "running" : (st.last_status || "idle"));
            document.getElementById("auto-status-label").textContent = running ? "Läuft" : (st.last_status || "Idle");
            document.getElementById("auto-next").textContent = st.next_run_at ? fmtDateTime(st.next_run_at) : "–";
            document.getElementById("auto-last").textContent = st.last_run_at ? fmtDateTime(st.last_run_at) : "–";
            document.getElementById("auto-duration").textContent = st.last_duration_sec ? fmtDuration(st.last_duration_sec) : "–";
            document.getElementById("auto-error").textContent = st.last_error || "–";
            document.getElementById("auto-plan").textContent = describePlan(cfg);
        }

        async function loadAutoConfig() {
            try {
                const res = await fetchJSON("/api/auto-index/config");
                renderAutoConfig(res);
            } catch (err) {
                console.error("Auto-Index Config laden fehlgeschlagen", err);
            }
        }

        async function loadAutoStatus() {
            try {
                const res = await fetchJSON("/api/auto-index/status");
                renderAutoConfig(res);
            } catch (err) {
                /* ignore */
            }
        }

        function statusLabel(code) {
            switch ((code || "idle").toLowerCase()) {
                case "running": return "Läuft";
                case "stopping": return "Stoppt";
                case "completed": return "Fertig";
                case "completed_with_errors": return "Fertig (Fehler)";
                default: return "Wartet";
            }
        }

        function updateStatusPill(text, code) {
            const pill = document.getElementById("status-pill");
            if (!pill) return;
            pill.textContent = text;
            pill.dataset.state = code || "idle";
        }

        async function refreshStatus() {
            try {
                const [statusData, idxData] = await Promise.all([
                    fetchJSON("/api/admin/status"),
                    fetchJSON("/api/admin/indexer_status"),
                ]);
                renderSummary(statusData, idxData);
            } catch (err) {
                console.error("Status laden fehlgeschlagen", err);
            }
        }

        function renderSummary(statusData, idxData) {
            const live = idxData.live || {};
            const activeId = live.run_id || idxData.run_id;
            const statusCode = live.status || (activeId ? "running" : "idle");
            const statusText = statusLabel(statusCode);
            updateStatusPill(statusText, statusCode);
            setText("metric-status", statusText);
            setText("metric-total-docs", fmtNumber(statusData.total_docs || 0));
            setText("metric-total-scan", fmtNumber(live.total_files ?? 0));
            const scanned = live.scanned ?? 0;
            setText("metric-scanned", fmtNumber(scanned));
            const errors = live.errors ?? 0;
            const ok = Math.max(0, scanned - errors);
            setText("metric-ok", fmtNumber(ok));
            setText("metric-errors", fmtNumber(errors));
            setText("metric-added", fmtNumber(live.added ?? 0));
            setText("metric-updated", fmtNumber(live.updated ?? 0));
            setText("metric-removed", fmtNumber(live.removed ?? 0));
            setText("metric-skipped", fmtNumber(live.skipped ?? 0));
            const totalFiles = live.total_files ?? 0;
            const progress = totalFiles > 0 ? Math.min(100, Math.round((scanned / totalFiles) * 100)) : 0;
            const bar = document.getElementById("progress-bar");
            if (bar) bar.style.width = `${progress}%`;
            setText("progress-text", totalFiles ? `${fmtNumber(scanned)} / ${fmtNumber(totalFiles)} (${progress}%)` : `${fmtNumber(scanned)} Dateien gescannt`);
            setText("run-id", activeId ? `#${activeId}` : "kein aktiver Lauf");
            setText("started-at", live.started_at ? fmtDateTime(live.started_at) : "–");
            setText("runtime-label", fmtDuration(live.elapsed_seconds || 0));
            const hb = idxData.heartbeat_age != null ? `${idxData.heartbeat_age}s` : "–";
            setText("heartbeat-label", hb);
            setText("current-file", live.current_path || "–");
            if (idxData.version) {
                setText("version-label", idxData.version);
            }
            if (idxData.last_run) {
                const last = idxData.last_run;
                const finished = last.finished_at ? fmtDateTime(last.finished_at) : "läuft";
                setText("last-run-label", `${fmtDateTime(last.started_at)} → ${finished}`);
            }
            updateQuarantineMeta(statusData);
            const toggle = document.getElementById("toggle-report");
            if (toggle) toggle.checked = Boolean(statusData.send_report_enabled);
            renderExtCounts(statusData.ext_counts || []);
            renderRuns(statusData.recent_runs || []);
        }

        function renderExtCounts(list) {
            const ext = document.getElementById("ext-counts");
            if (!ext) return;
            ext.innerHTML = "";
            list.forEach((row) => {
                const chip = document.createElement("span");
                chip.className = "chip";
                chip.textContent = `${row.extension || "?"}: ${fmtNumber(row.count || row.c || 0)}`;
                ext.appendChild(chip);
            });
        }

        function renderRuns(runs) {
            const body = document.getElementById("runs-body");
            if (!body) return;
            body.innerHTML = "";
            runs.forEach((r) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${fmtDateTime(r.started_at)}${r.finished_at ? " → " + fmtDateTime(r.finished_at) : ""}</td>
                    <td>${r.status || ""}</td>
                    <td>${fmtNumber(r.scanned_files || 0)}</td>
                    <td>${fmtNumber(r.added || 0)}</td>
                    <td>${fmtNumber(r.errors || 0)}</td>`;
                body.appendChild(tr);
            });
        }

        async function loadErrors() {
            try {
                const data = await fetchJSON(`/api/admin/errors?limit=${state.errorLimit}&offset=${state.errorOffset}`);
                const box = document.getElementById("errors");
                box.innerHTML = "";
                (data.errors || []).forEach((e) => {
                    const div = document.createElement("div");
                    div.className = "error-item";
                    div.textContent = `${e.created_at}: ${e.path} — ${e.error_type} (${e.message})`;
                    box.appendChild(div);
                });
                const total = data.total || 0;
                const start = total === 0 ? 0 : Math.min(total, state.errorOffset + 1);
                const end = Math.min(total, state.errorOffset + state.errorLimit);
                setText("errors-info", `${start} - ${end} / ${total}`);
                document.getElementById("prev-errors").disabled = state.errorOffset <= 0;
                document.getElementById("next-errors").disabled = state.errorOffset + state.errorLimit >= total;
            } catch (err) {
                setText("errors-info", `Fehler beim Laden: ${err}`);
            }
        }

        function updateAutoScrollButton() {
            const btn = document.getElementById("toggle-autoscroll");
            if (btn) {
                btn.textContent = state.autoScrollLog ? "Autoscroll an" : "Autoscroll aus";
            }
        }

        function scrollLogIfNeeded(force = false) {
            const box = document.getElementById("indexer-log");
            if (!box) return;
            const nearBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 60;
            if (force || (state.autoScrollLog && nearBottom)) {
                box.scrollTop = box.scrollHeight;
            }
        }

        async function loadLog({ forceReplace = false, live = true } = {}) {
            try {
                let url = "/api/admin/indexer_log";
                if (state.logOffset === 0 && live) {
                    if (state.logPointer === 0 || forceReplace) {
                        url += `?tail=${state.logTail}`;
                    } else {
                        url += `?since=${state.logPointer}`;
                    }
                } else {
                    url += `?offset=${state.logOffset}&limit=${state.logTail}`;
                }
                const data = await fetchJSON(url);
                const box = document.getElementById("indexer-log");
                const lines = data.lines || [];
                const appendMode = state.logOffset === 0 && live && state.logPointer && !forceReplace;
                if (appendMode && lines.length) {
                    const needsNL = box.textContent && !box.textContent.endsWith("\n");
                    box.textContent += (needsNL ? "\n" : "") + lines.join("");
                } else if (data.total === 0) {
                    box.textContent = "Keine Log-Einträge";
                } else if (lines.length) {
                    box.textContent = lines.join("");
                }
                state.logTotal = data.total || state.logTotal;
                state.logPointer = live ? (data.total || state.logPointer) : state.logPointer;
                const start = data.from || 0;
                const end = start + lines.length;
                const mode = state.logOffset === 0 && live ? "Live" : "Archiv";
                setText("log-info", data.total ? `${mode}: Zeilen ${start + 1} - ${end} / ${data.total}` : "Keine Log-Einträge");
                document.getElementById("older-log").disabled = (data.total || 0) <= state.logTail;
                scrollLogIfNeeded(forceReplace || appendMode);
            } catch (err) {
                setText("log-info", `Log laden fehlgeschlagen: ${err}`);
                const box = document.getElementById("indexer-log");
                if (box) box.textContent = `Fehler: ${err}`;
            }
        }

        async function loadChildren(path) {
            const data = await fetchJSON(`/api/admin/tree?parent=${encodeURIComponent(path || "")}`);
            return data.children || [];
        }

        function createNode(n, depth = 0) {
            const li = document.createElement("li");
            const toggle = document.createElement("span");
            toggle.className = "toggle";
            toggle.textContent = n.has_children ? "▶" : "";
            toggle.addEventListener("click", async (e) => {
                e.stopPropagation();
                if (!n.has_children) return;
                if (li.dataset.expanded === "true") {
                    li.dataset.expanded = "false";
                    toggle.textContent = "▶";
                    const childUl = li.querySelector("ul");
                    if (childUl) childUl.remove();
                } else {
                    li.dataset.expanded = "true";
                    toggle.textContent = "▼";
                    const childUl = document.createElement("ul");
                    const children = await loadChildren(n.path);
                    children.forEach((c) => childUl.appendChild(createNode(c, depth + 1)));
                    li.appendChild(childUl);
                }
            });
            const label = document.createElement("span");
            label.textContent = n.name;
            label.title = n.path;
            label.addEventListener("click", (e) => {
                e.stopPropagation();
                document.getElementById("new-path").value = n.path;
            });
            li.appendChild(toggle);
            li.appendChild(label);
            return li;
        }

        async function loadTree() {
            const data = await fetchJSON("/api/admin/tree");
            state.baseRoot = data.base;
            document.getElementById("base-root").textContent = data.base;
            const container = document.getElementById("tree");
            container.innerHTML = "";
            const rootBtn = document.createElement("button");
            rootBtn.className = "btn btn-secondary";
            rootBtn.textContent = data.base;
            rootBtn.addEventListener("click", () => {
                document.getElementById("new-path").value = data.base;
            });
            container.appendChild(rootBtn);
            const ul = document.createElement("ul");
            (data.children || []).forEach((c) => ul.appendChild(createNode(c, 0)));
            container.appendChild(ul);
        }

        async function loadRoots() {
            const data = await fetchJSON("/api/admin/roots");
            const list = document.getElementById("roots");
            list.innerHTML = "";
            data.roots.forEach((r) => {
                const div = document.createElement("div");
                div.className = "root-item";
                div.innerHTML = `<span>${r.label || ""} — ${r.path}</span>
                <span class="root-actions chips">
                    <button class="btn btn-secondary" data-act="${r.id}" data-active="${!r.active}">${r.active ? "Deaktivieren" : "Aktivieren"}</button>
                    <button class="btn btn-ghost" data-del="${r.id}">Löschen</button>
                </span>`;
                list.appendChild(div);
            });
            list.querySelectorAll("button[data-act]").forEach((btn) => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.act;
                    const active = btn.dataset.active === "true";
                    if (!active) {
                        if (!confirm("Quelle deaktivieren?")) return;
                    }
                    await fetchJSON(`/api/admin/roots/${id}/activate?active=${active}`, { method: "POST" });
                    loadRoots();
                });
            });
            list.querySelectorAll("button[data-del]").forEach((btn) => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.del;
                    if (!confirm("Quelle wirklich löschen?")) return;
                    if (!confirm("Sicher, Quelle entfernen?")) return;
                    await fetchJSON(`/api/admin/roots/${id}`, { method: "DELETE" });
                    loadRoots();
                });
            });
        }

        document.getElementById("start-run").addEventListener("click", () => triggerRun(false));
        document.getElementById("reset-run").addEventListener("click", async () => {
            if (confirm("Index leeren? Dies startet keinen neuen Lauf.") && confirm("Wirklich Index löschen? Daten gehen verloren.")) {
                await fetchJSON(`/api/admin/index/reset`, { method: "POST" });
                refreshStatus();
                loadLog({ forceReplace: true });
            }
        });
        document.getElementById("preflight").addEventListener("click", async () => {
            const data = await fetchJSON("/api/admin/preflight");
            const box = document.getElementById("preflight-result");
            box.textContent = `PDF ${data.counts[".pdf"]} | RTF ${data.counts[".rtf"]} | MSG ${data.counts[".msg"]} | TXT ${data.counts[".txt"]}`;
        });
        document.getElementById("reset-run-start").addEventListener("click", async () => {
            if (confirm("Index leeren und direkt neu starten?") && confirm("Sicher? Alle Indexdaten werden gelöscht.")) {
                await fetchJSON(`/api/admin/index/reset_run`, { method: "POST" });
            }
        });
        document.getElementById("stop-run").addEventListener("click", async () => {
            await fetchJSON(`/api/admin/index/stop`, { method: "POST" });
        });
        document.getElementById("add-root").addEventListener("click", async () => {
            const path = document.getElementById("new-path").value.trim();
            const label = document.getElementById("new-label").value.trim();
            if (!path) return;
            await fetchJSON(`/api/admin/roots?path=${encodeURIComponent(path)}&label=${encodeURIComponent(label)}`, { method: "POST" });
            loadRoots();
        });

        const reportToggle = document.getElementById("toggle-report");
        if (reportToggle) {
            reportToggle.addEventListener("change", async (e) => {
                const enabled = e.target.checked;
                await fetchJSON(`/api/admin/reporting/send_report?enabled=${enabled}`, { method: "POST" });
            });
        }

        document.getElementById("auto-enabled").addEventListener("change", saveAutoConfig);
        document.querySelectorAll("#auto-mode-buttons button").forEach((btn) => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.mode;
                if (!mode) return;
                state.autoMode = mode;
                renderAutoModeButtons(mode);
                toggleAutoInputs(mode);
                saveAutoConfig();
            });
        });
        document.getElementById("auto-time").addEventListener("change", saveAutoConfig);
        document.querySelectorAll("#auto-weekdays button").forEach((btn) => {
            btn.addEventListener("click", () => {
                renderWeekdayButtons(parseInt(btn.dataset.day, 10));
                saveAutoConfig();
            });
        });
        document.querySelectorAll("#auto-interval-buttons button").forEach((btn) => {
            btn.addEventListener("click", () => {
                renderIntervalButtons(parseInt(btn.dataset.interval, 10));
                saveAutoConfig();
            });
        });
        document.getElementById("auto-save").addEventListener("click", saveAutoConfig);
        document.getElementById("auto-run-now").addEventListener("click", async () => {
            try {
                const res = await fetch("/api/auto-index/run", { method: "POST" });
                if (res.status === 409) {
                    alert("Indexlauf läuft bereits");
                }
            } catch (err) {
                console.error("Auto-Index-Run fehlgeschlagen", err);
            }
        });

        async function triggerRun(fullReset = false) {
            const res = await fetch(`/api/admin/index/run?full_reset=${fullReset}`, { method: "POST" });
            if (res.status === 409) {
                alert("Indexlauf läuft bereits");
            }
        }

        document.getElementById("older-log").addEventListener("click", () => {
            const total = state.logTotal || 0;
            state.logOffset = Math.min(total, state.logOffset + state.logTail);
            state.logPointer = 0;
            loadLog({ forceReplace: true, live: false });
        });
        document.getElementById("live-log").addEventListener("click", () => {
            state.logOffset = 0;
            state.logPointer = 0;
            loadLog({ forceReplace: true, live: true });
            scrollLogIfNeeded(true);
        });
        document.getElementById("refresh-log").addEventListener("click", () => loadLog({ forceReplace: true }));
        document.getElementById("toggle-autoscroll").addEventListener("click", () => {
            state.autoScrollLog = !state.autoScrollLog;
            updateAutoScrollButton();
            scrollLogIfNeeded(true);
        });

        wireQuarantineControls();

        async function refreshAll() {
            try {
                await Promise.all([loadTree(), loadRoots(), refreshStatus(), loadLog({ forceReplace: true }), loadAutoConfig()]);
            } catch (err) {
                console.error("Initiales Laden fehlgeschlagen", err);
            }
            loadQuarantine();
        }

        refreshAll();
        updateAutoScrollButton();
        setInterval(() => { refreshStatus(); }, POLL_STATUS_MS);
        setInterval(() => { if (state.logOffset === 0) loadLog({ live: true }); }, POLL_LOG_MS);
        setInterval(() => { loadAutoStatus(); }, 5000);
        setInterval(() => { loadQuarantine(); }, 20000);
    </script>
</body>
</html>
